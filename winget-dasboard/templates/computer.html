{% extends "base.html" %}

{% block title %}Szczegóły - {{ computer.hostname }}{% endblock %}

{% block content %}
    <div class="header-container">
        <a href="{{ url_for('index') }}" class="back-link">&larr; Powrót do listy</a>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="{{ url_for('computer_history', hostname=computer.hostname) }}" class="action-btn btn-secondary">Pokaż historię</a>
            <button id="theme-toggle" title="Zmień motyw">
                 <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                 <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </div>

    <h1>Szczegóły komputera: {{ computer.hostname }} (Ostatni raport)</h1>
    <p><strong>IP:</strong> {{ computer.ip_address }} | <strong>Ostatni raport:</strong> {{ computer.last_report | to_local_time }}</p>

    <h2>Dostępne aktualizacje ({{ updates|length }})</h2>
    <table>
        <thead style="background-color: #28a745;">
            <tr>
                <th>Typ</th>
                <th>Nazwa / Tytuł</th>
                <th>Status</th>
                <th>Wersja obecna</th>
                <th>Wersja dostępna / Nr KB</th>
                <th>Akcja</th>
            </tr>
        </thead>
        <tbody>
            {% for update in updates %}
            <tr>
                <td>{{ 'System Operacyjny' if update.update_type == 'OS' else 'Aplikacja' }}</td>
                <td>{{ update.name }}</td>
                <td>
                    {% if update.status == 'Oczekuje' %}
                        <span class="status-pending">{{ update.status }}</span>
                    {% elif update.status == 'Niepowodzenie' %}
                        <span class="status-fail">{{ update.status }}</span>
                    {% else %}
                        <span>{{ update.status }}</span>
                    {% endif %}
                </td>
                <td>{{ update.current_version or 'N/A' }}</td>
                <td>{{ update.available_version or 'N/A' }}</td>
                <td>
                    {% if update.update_type == 'APP' and update.status != 'Oczekuje' %}
                    <button class="action-btn update-btn"
                            data-computer-id="{{ computer.id }}"
                            data-update-id="{{ update.id }}"
                            data-package-id="{{ update.app_id }}">
                        Aktualizuj
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6">Brak oczekujących aktualizacji.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Zainstalowane aplikacje ({{ apps|length }})</h2>
    <table>
        <thead style="background-color: #17a2b8;"><tr><th>Nazwa</th><th>ID Aplikacji</th><th>Wersja</th></tr></thead>
        <tbody>
            {% for app in apps %}
            <tr><td>{{ app.name }}</td><td>{{ app.app_id }}</td><td>{{ app.version }}</td></tr>
            {% else %}
            <tr><td colspan="3">Brak danych o aplikacjach.</td></tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
    // --- POPRAWKA: Usunięto otaczające tagi <script> ---
    // Logika dla przycisków "Aktualizuj"
    document.querySelectorAll('.update-btn').forEach(button => {
        button.addEventListener('click', function() {
            const computerId = this.dataset.computerId;
            const updateId = this.dataset.updateId;
            const packageId = this.dataset.packageId;
            const appName = this.closest('tr').cells[1].textContent;
            if (!confirm(`Czy na pewno chcesz zlecić aktualizację aplikacji "${appName}"?`)) {
                return;
            }
            this.textContent = 'Zlecanie...';
            this.disabled = true;
            fetch(`/computer/${computerId}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ package_id: packageId, update_id: updateId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.textContent = 'Zlecono';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    this.textContent = 'Błąd!';
                    alert('Wystąpił błąd po stronie serwera: ' + data.message);
                    this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Błąd Fetch:', error);
                this.textContent = 'Błąd sieci!';
                this.disabled = false;
            });
        });
    });
{% endblock %}
