{% extends "base.html" %}

{% block title %}Strona główna{% endblock %}

{% block content %}
    <div class="header-container">
        <h1>Komputery w sieci</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="{{ url_for('report_all') }}" class="action-btn btn-report">Generuj raport zbiorczy</a>
            <button id="theme-toggle" title="Zmień motyw">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </div>

    <table>
        <thead style="background-color: #007bff;">
            <tr>
                <th>Nazwa hosta</th>
                <th>Adres IP</th>
                <th>Ostatni raport</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for computer in computers %}
            <tr>
                <td><a href="{{ url_for('computer_details', hostname=computer.hostname) }}">{{ computer.hostname }}</a></td>
                <td>{{ computer.ip_address }}</td>
                <td>{{ computer.last_report | to_local_time }}</td>
                <td>
                    <div class="actions-cell">
                        <a href="{{ url_for('report_single', computer_id=computer.id) }}" class="action-btn btn-report">Generuj raport</a>
                        <button class="action-btn refresh-btn" data-computer-id="{{ computer.id }}">Odśwież</button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4">Brak komputerów w bazie danych. Oczekiwanie na pierwszy raport...</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
    // --- POPRAWKA: Usunięto otaczające tagi <script> ---
    // Logika dla przycisku Odśwież
    document.querySelectorAll('.refresh-btn').forEach(button => {
        button.addEventListener('click', function() {
            const computerId = this.dataset.computerId;
            this.textContent = 'Wysyłanie...';
            this.disabled = true;
            fetch(`/computer/${computerId}/refresh`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.textContent = 'Zlecono';
                    setTimeout(() => { this.textContent = 'Odśwież'; this.disabled = false; }, 2000);
                } else {
                    this.textContent = 'Błąd!'; this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Błąd Fetch:', error);
                this.textContent = 'Błąd sieci!'; this.disabled = false;
            });
        });
    });
{% endblock %}