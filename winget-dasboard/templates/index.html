{% extends "base.html" %}

{% block title %}Strona główna{% endblock %}

{# Wstawiamy nagłówek H1 do lewego bloku w głównym nagłówku #}
{% block header_main_left %}
    <h1>Komputery w sieci</h1>
{% endblock %}

{# Wstawiamy przyciski akcji do prawego bloku w głównym nagłówku #}
{% block header_main_right %}
    <a href="{{ url_for('report_all') }}" class="action-btn btn-report">Generuj raport zbiorczy</a>
{% endblock %}

{# Pod-nagłówek na tej stronie jest pusty #}
{% block sub_header %}{% endblock %}

{% block content %}
    <table>
        <thead style="background-color: #007bff;">
            <tr>
                <th>Nazwa hosta</th>
                <th>Adres IP</th>
                <th>Ostatni raport</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for computer in computers %}
            <tr>
                <td><a href="{{ url_for('computer_details', hostname=computer.hostname) }}">{{ computer.hostname }}</a></td>
                <td>{{ computer.ip_address }}</td>
                <td>{{ computer.last_report | to_local_time }}</td>
                <td>
                    <div class="actions-cell">
                        <a href="{{ url_for('report_single', computer_id=computer.id) }}" class="action-btn btn-report">Generuj raport</a>
                        <button class="action-btn refresh-btn" data-computer-id="{{ computer.id }}">Odśwież</button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4">Brak komputerów w bazie danych. Oczekiwanie na pierwszy raport...</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
    // Logika dla przycisku Odśwież
    document.querySelectorAll('.refresh-btn').forEach(button => {
        button.addEventListener('click', function() {
            const computerId = this.dataset.computerId;
            this.textContent = 'Wysyłanie...';
            this.disabled = true;
            fetch(`/computer/${computerId}/refresh`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.textContent = 'Zlecono';
                    setTimeout(() => { this.textContent = 'Odśwież'; this.disabled = false; }, 2000);
                } else {
                    this.textContent = 'Błąd!'; this.disabled = false;
                }
            })
            .catch(error => {
                console.error('Błąd Fetch:', error);
                this.textContent = 'Błąd sieci!'; this.disabled = false;
            });
        });
    });
{% endblock %}